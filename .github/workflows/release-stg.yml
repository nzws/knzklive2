name: Release - staging

on:
  push:
    branches:
      - main

jobs:
  check:
    uses: ./.github/workflows/_lint.yml

  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      push: ${{ steps.filter.outputs.push }}
      edge: ${{ steps.filter.outputs.edge }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 20
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            server:
              - 'apps/server/**'
            push:
              - 'apps/push/**'
            edge:
              - 'apps/edge/**'

  deploy:
    name: Deploy Edge Network
    needs: [check, changes]
    if: ${{ needs.changes.outputs.edge == 'true' }}
    uses: ./.github/workflows/_edge.yml
    with:
      environment: staging
    secrets:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

  build-server:
    name: Build/Deploy server
    needs: [check, changes]
    if: ${{ needs.changes.outputs.server == 'true' }}
    uses: ./.github/workflows/_build_server.yml
    with:
      tag: staging
      environment: staging
    secrets:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  build-push:
    name: Build push
    needs: [check, changes]
    if: ${{ needs.changes.outputs.push == 'true' }}
    uses: ./.github/workflows/_build_push.yml
    with:
      tag: staging
      environment: staging
